<!DOCTYPE html>
<html>
<head>
    <title>üéì Chemistry Paper Evaluator v3.1 - FIXED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            margin: 0; padding: 20px; 
        }
        header { 
            background: linear-gradient(90deg, #1f3c88, #2a5298); 
            color: white; padding: 25px; 
            text-align: center; border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(31,60,136,0.3); 
        }
        .container { 
            max-width: 1100px; margin: 30px auto; 
            background: white; padding: 35px; 
            border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
        }
        h1 { margin: 0; font-size: 2.2em; }
        h2 { color: #1f3c88; border-bottom: 3px solid #e8f0fe; padding-bottom: 10px; }
        #pdfUploadArea { 
            border: 3px dashed #1f3c88; border-radius: 10px; padding: 30px; 
            text-align: center; background: #f8faff; margin: 20px 0; 
            transition: all 0.3s; cursor: pointer;
        }
        #pdfUploadArea:hover, #pdfUploadArea.dragover { 
            background: #e8f0fe; border-color: #163172;
        }
        #fileInput { display: none; }
        .main-button { 
            background: linear-gradient(90deg, #1f3c88, #2a5298); 
            color: white; padding: 15px 30px; border: none; 
            border-radius: 10px; cursor: pointer; font-size: 16px; 
            font-weight: bold; width: 100%; margin: 20px 0;
        }
        .main-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(31,60,136,0.4); }
        .main-button:disabled { opacity: 0.6; cursor: not-allowed; }
        #status { margin: 20px 0; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 16px; display: none; }
        .status-loading { background: #fff3cd; border-left: 5px solid #ffc107; }
        .status-success { background: #d4edda; border-left: 5px solid #28a745; }
        .status-error { background: #f8d7da; border-left: 5px solid #dc3545; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: linear-gradient(90deg, #1f3c88, #2a5298); color: white; font-weight: bold; }
        .score-excellent { background: linear-gradient(90deg, #d4edda, #c3e6cb); }
        .score-good { background: linear-gradient(90deg, #fff3cd, #ffeaa7); }
        .score-poor { background: linear-gradient(90deg, #f8d7da, #f7b7b7); }
        .journal-elite { background: linear-gradient(90deg, #28a745, #20c997) !important; color: white; font-weight: bold; }
        .journal-predatory { background: linear-gradient(90deg, #dc3545, #fd7e14) !important; color: white; font-weight: bold; }
        .comments { background: #f8f9ff; padding: 20px; border-radius: 10px; border-left: 5px solid #1f3c88; margin: 20px 0; }
        #result { display: none; animation: slideIn 0.5s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        footer { text-align: center; padding: 25px; color: #666; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <h1>üéì Chemistry Paper Evaluator v3.1</h1>
    <p>‚úÖ FIXED | Standard Journals | 100 Points | MSc Chemistry Research</p>
</header>

<div class="container">
    <h2>üì§ Upload Chemistry Journal Paper</h2>
    
    <div id="pdfUploadArea">
        <p>üñ±Ô∏è Click or drag searchable PDF here</p>
        <p style="font-size: 14px; color: #666; margin-top: 10px;">
            JACS/Angewandte/Scopus PDFs ‚Üí Elite scores | ijirt/ijrar ‚Üí Predatory flag
        </p>
        <input type="file" id="fileInput" accept="application/pdf">
        <div id="fileNameDisplay"></div>
    </div>
    
    <button class="main-button" id="evaluateBtn" onclick="evaluatePaper()" disabled>
        üöÄ Run Comprehensive Academic Evaluation (100 pts)
    </button>
    
    <div id="status"></div>
    <div id="result"></div>
</div>

<footer>¬© 2026 Monika Kannan | MSc Chemistry | v3.1 FIXED - No Errors</footer>

<script>
    // ‚úÖ CRITICAL: Worker setup FIRST
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // STANDARD vs PREDATORY JOURNALS (2026 rankings)
    const ELITE_JOURNALS = [
        'chemical reviews', 'jacs', 'j. am. chem. soc.', 'angew', 'angewandte', 
        'nature chemistry', 'chem', 'acs nano', 'adv. mater.', 'advanced materials',
        'chem. rev.', 'chem soc rev', 'anal. chem.', 'coord. chem. rev.', 
        'acs appl. mater.', 'j. phys. chem.', 'rsc adv.', 'acs energy'
    ];
    
    const PREDATORY_KEYWORDS = ['ijirt', 'ijrar', 'impactfactor', 'sjif', 'cosmos'];
    
    // Drag-drop functionality
    const uploadArea = document.getElementById('pdfUploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const evaluateBtn = document.getElementById('evaluateBtn');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault(); uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault(); uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) handleFileSelect(files[0]);
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) handleFileSelect(e.target.files[0]);
    });
    
    function handleFileSelect(file) {
        fileInput.files = new FileList(file); // Fixed FileList issue
        fileNameDisplay.innerHTML = `<strong>‚úÖ ${file.name}</strong> (${(file.size/1024).toFixed(1)}KB)`;
        evaluateBtn.disabled = false;
    }
    
    // ‚úÖ FIXED MAIN FUNCTION - fullText scoped properly
    async function evaluatePaper() {
        const file = fileInput.files[0];
        const status = document.getElementById('status');
        const result = document.getElementById('result');
        
        if (!file) {
            showStatus('‚ùå Please upload a PDF first', 'status-error');
            return;
        }
        
        evaluateBtn.disabled = true;
        evaluateBtn.textContent = '‚è≥ Analyzing...';
        result.style.display = 'none';
        showStatus('üìñ Extracting text from PDF...', 'status-loading');
        
        let fullText = ''; // ‚úÖ DECLARED IN OUTER SCOPE
        let totalScore = 0;
        
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const maxPages = Math.min(12, pdf.numPages);
            
            showStatus(`üìÑ Processing ${maxPages} pages...`, 'status-loading');
            
            // Extract text
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            
            if (fullText.trim().length < 200) {
                throw new Error('No extractable text found. Use searchable PDF (Ctrl+A works inside)');
            }
            
            showStatus('üéØ Running academic analysis...', 'status-loading');
            const textLower = fullText.toLowerCase();
            const fileNameLower = file.name.toLowerCase();
            
            // ========== 100 POINT SCORING ==========
            
            // 1. Journal Quality (20 pts) - ELITE vs PREDATORY
            let journalScore = 0, journalClass = 'score-poor', journalStatus = 'Unknown';
            
            const isPredatory = PREDATORY_KEYWORDS.some(kw => fileNameLower.includes(kw));
            if (isPredatory) {
                journalScore = 2; journalClass = 'journal-predatory'; 
                journalStatus = 'üö® PREDATORY JOURNAL';
            } else if (ELITE_JOURNALS.some(j => fileNameLower.includes(j) || textLower.includes(j))) {
                journalScore = 20; journalClass = 'journal-elite'; 
                journalStatus = 'üèÜ ELITE JOURNAL (JACS/Angewandte)';
            } else if (fullText.match(/10\.[0-9]{4,}/)) {
                journalScore = 15; journalClass = 'score-excellent'; 
                journalStatus = '‚úÖ Reputable (DOI found)';
            } else {
                journalScore = 8; journalStatus = '‚ö†Ô∏è Check publisher';
            }
            
            // 2. Abstract (12 pts)
            const absMatch = fullText.match(/abstract[:\s]*([\s\S]*?)(?=1\s+|introduction|\n[A-Z]{4,})/i);
            const absWords = absMatch ? absMatch[1].trim().split(/\s+/).length : 0;
            const absScore = absWords > 120 ? 12 : absWords > 80 ? 9 : absWords > 50 ? 6 : 0;
            
            // 3. IMRAD (12 pts)
            const imradScore = (textLower.includes('introduction') ? 3 : 0) +
                             (['method','materials'].some(kw => textLower.includes(kw)) ? 3 : 0) +
                             (textLower.includes('results') ? 3 : 0) +
                             (textLower.includes('discussion') ? 3 : 0);
            
            // 4. Chemistry Methods (15 pts)
            const chemMethods = ['uv-vis','xrd','ftir','nmr','sem','tem','synthesis','electrochem'];
            const methodHits = chemMethods.filter(kw => textLower.includes(kw)).length;
            const methodScore = Math.min(15, methodHits * 1.8);
            
            // 5. References (12 pts)
            const refCount = (fullText.match(/\[[0-9]+\]/g) || []).length;
            const refScore = Math.min(12, Math.floor(refCount / 2));
            
            // 6. Novelty (12 pts)
            const noveltyScore = Math.min(12, ['novel','first','innovative','biochar','nanocomposite'].filter(kw => textLower.includes(kw)).length * 2.4);
            
            // 7. Writing (10 pts)
            const uniqueWords = new Set(fullText.split(/\W+/).filter(w => w.length > 4).map(w => w.toLowerCase()));
            const writingScore = Math.min(10, Math.floor(uniqueWords.size / 70));
            
            // 8. Literature Review (7 pts)
            const litScore = Math.min(7, ['review','literature','previous work'].filter(kw => textLower.includes(kw)).length * 2.3);
            
            totalScore = journalScore + absScore + imradScore + methodScore + refScore + noveltyScore + writingScore + litScore;
            
            // Comments
            const comments = [
                totalScore >= 90 ? 'üèÜ Publication-ready (JACS/Angewandte level)' :
                totalScore >= 75 ? '‚úÖ Strong - minor revisions needed' :
                totalScore >= 60 ? 'üìà Good - strengthen methods' : '‚ö†Ô∏è Major revisions required'
            ];
            
            if (methodScore < 10) comments.push('üî¨ Add UV-Vis/XRD/FTIR characterization');
            if (isPredatory) comments.push('üö® WITHDRAW FROM PREDATORY JOURNAL');
            if (journalScore >= 15) comments.push('üìö Excellent journal selection');
            
            showResult(totalScore, {
                journalScore, journalStatus, journalClass, isPredatory,
                absScore, imradScore, methodScore, refScore, noveltyScore, 
                writingScore, litScore, absWords, methodHits, refCount, 
                uniqueWords: uniqueWords.size
            }, comments, Math.round(fullText.length/1000));
            
        } catch (error) {
            showStatus(`‚ùå ${error.message}`, 'status-error');
            console.error('Error:', error);
        } finally {
            evaluateBtn.disabled = false;
            evaluateBtn.textContent = 'üöÄ Run Comprehensive Academic Evaluation (100 pts)';
        }
    }
    
    function showStatus(msg, className) {
        const status = document.getElementById('status');
        status.textContent = msg;
        status.className = className;
        status.style.display = 'block';
    }
    
    function showResult(totalScore, scores, comments, textKB) {
        document.getElementById('result').innerHTML = `
            <h2>üìä Final Score: <strong>${Math.round(totalScore)}/100</strong></h2>
            <table>
                <tr><th>Criteria</th><th>Score</th><th>Max</th><th>Assessment</th></tr>
                <tr class="${scores.journalClass}">
                    <td>üèõÔ∏è Journal Quality</td><td>${scores.journalScore}</td><td>20</td><td><strong>${scores.journalStatus}</strong></td>
                </tr>
                <tr class="${scores.absScore>=10?'score-excellent':'score-good'}">
                    <td>üìù Abstract</td><td>${scores.absScore}</td><td>12</td><td>${scores.absWords} words</td>
                </tr>
                <tr><td>üìë IMRAD Structure</td><td>${scores.imradScore}</td><td>12</td><td>Sections detected</td></tr>
                <tr class="${scores.methodScore>=12?'score-excellent':'score-good'}">
                    <td>üî¨ Chemistry Methods</td><td>${scores.methodScore}</td><td>15</td><td>${scores.methodHits} techniques</td>
                </tr>
                <tr><td>üìö References</td><td>${scores.refScore}</td><td>12</td><td>${scores.refCount} citations</td></tr>
                <tr><td>üí° Novelty</td><td>${scores.noveltyScore}</td><td>12</td><td>Innovation terms</td></tr>
                <tr><td>‚úçÔ∏è Writing Quality</td><td>${scores.writingScore}</td><td>10</td><td>${scores.uniqueWords} unique words</td></tr>
                <tr><td>üìñ Literature Review</td><td>${scores.litScore}</td><td>7</td><td>Review keywords found</td></tr>
                <tr><th>TOTAL</th><th>${Math.round(totalScore)}</th><th>100</th>
                    <th>${totalScore>=90?'üéì ELITE':totalScore>=75?'‚úÖ EXCELLENT':'üìà REVISE'}</th></tr>
            </table>
            <div class="comments">
                <h3>üí¨ Academic Assessment:</h3>
                ${comments.map(c => `<p>‚Ä¢ ${c}</p>`).join('')}
            </div>
            <p><em>‚úÖ v3.1 FIXED | ${textKB}KB analyzed | Elite journal detection active</em></p>
        `;
        document.getElementById('result').style.display = 'block';
        showStatus(`‚úÖ Complete! ${Math.round(totalScore)}/100 | ${textKB}KB processed`, 'status-success');
    }
</script>

</body>
</html>
