<!DOCTYPE html>
<html>
<head>
  <title>PDF Evaluation - Debug Version</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
  <style>
    body { font-family: monospace; padding: 20px; font-size: 14px; }
    button { padding: 10px; margin: 10px 0; }
    #debug { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    td, th { border: 1px solid #ccc; padding: 8px; }
    th { background: #e0e0e0; }
    .error { color: red; font-weight: bold; }
    .success { color: green; }
  </style>
</head>
<body>

<h2>üîç PDF Evaluation - Diagnostic Mode</h2>
<input type="file" id="pdfUpload" accept="application/pdf">
<button onclick="diagnosePDF()">Diagnose PDF</button>

<div id="debug"></div>
<div id="result"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js';

async function diagnosePDF() {
  const fileInput = document.getElementById("pdfUpload");
  const file = fileInput.files[0];
  const debugDiv = document.getElementById("debug");
  const resultDiv = document.getElementById("result");
  
  debugDiv.innerHTML = '';
  resultDiv.innerHTML = '';

  if (!file) {
    debugDiv.innerHTML = '<span class="error">‚ùå No file selected</span>';
    return;
  }

  debugDiv.innerHTML = '<span class="success">‚úÖ File loaded: ' + file.name + ' (' + (file.size/1024).toFixed(1) + 'KB)</span>';

  try {
    // Test 1: PDF.js loading
    const arrayBuffer = await file.arrayBuffer();
    debugDiv.innerHTML += '<br><span class="success">‚úÖ PDF.js loaded successfully</span>';
    
    // Test 2: Load PDF document
    const loadingTask = pdfjsLib.getDocument(arrayBuffer);
    const pdf = await loadingTask.promise;
    debugDiv.innerHTML += `<br><span class="success">‚úÖ PDF loaded: ${pdf.numPages} pages</span>`;
    
    // Test 3: Extract text from first page only (fastest test)
    const page1 = await pdf.getPage(1);
    const textContent1 = await page1.getTextContent();
    const page1Text = textContent1.items.map(item => item.str).join(' ').trim();
    
    debugDiv.innerHTML += `<br><span class="success">‚úÖ Page 1 text extracted (${page1Text.length} chars):<br><pre>${page1Text.substring(0, 200)}${page1Text.length > 200 ? '...' : ''}</pre></span>`;

    if (page1Text.length === 0) {
      debugDiv.innerHTML += '<span class="error">‚ö†Ô∏è  Page 1 has no extractable text (likely scanned/image PDF)</span>';
      return showScannedPDFResult();
    }

    // Full evaluation if text found
    await fullEvaluation(pdf, debugDiv, resultDiv);
    
  } catch (error) {
    debugDiv.innerHTML += `<br><span class="error">‚ùå Error: ${error.message}</span>`;
    console.error('Full error:', error);
    
    if (error.message.includes('worker')) {
      debugDiv.innerHTML += '<br><span class="error">üîß Worker failed. Try Chrome incognito or different browser.</span>';
    } else if (error.message.includes('InvalidPDF')) {
      debugDiv.innerHTML += '<br><span class="error">üìÑ Corrupted/damaged PDF file.</span>';
    }
  }
}

async function fullEvaluation(pdf, debugDiv, resultDiv) {
  debugDiv.innerHTML += '<br><span class="success">üî¨ Running full content analysis...</span>';
  
  let fullText = '';
  for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) { // Limit to 5 pages for speed
    const page = await pdf.getPage(i);
    const textContent = await page.getTextContent();
    fullText += textContent.items.map(item => item.str).join(' ') + '\n';
  }
  
  const textLower = fullText.toLowerCase();
  
  // SIMPLIFIED SCORING (no regex - just keyword presence)
  let scores = {
    abstract: textLower.includes('abstract') ? 10 : 2,
    methods: ['method', 'materials', 'experiment'].some(kw => textLower.includes(kw)) ? 15 : 5,
    citations: (fullText.match(/\[\d+\]/g) || []).length > 2 ? 12 : 4,
    chemistry: ['uv-vis', 'nmr', 'xrd', 'spectroscopy'].some(kw => textLower.includes(kw)) ? 12 : 3,
    journal: 15 // default
  };
  
  const total = Object.values(scores).reduce((a,b)=>a+b, 0);
  
  resultDiv.innerHTML = `
    <h3>‚úÖ Evaluation Complete: ${total}/67</h3>
    <table>
      <tr><th>Criteria</th><th>Score</th><th>Detection</th></tr>
      ${Object.entries(scores).map(([k,v]) => 
        `<tr><td>${k.charAt(0).toUpperCase()+k.slice(1)}</td><td>${v}</td><td>${textLower.includes(k) ? '‚úÖ Found' : '‚ùå Missing'}</td></tr>`
      ).join('')}
      <tr><th>Total</th><th>${total}/67</th><th></th></tr>
    </table>
    <p><em>Analyzed first ${Math.min(pdf.numPages,5)} pages. Chemistry-focused scoring.</em></p>
  `;
  
  debugDiv.innerHTML += `<br><span class="success">üéâ SUCCESS! ${fullText.length/1000}KB text analyzed.</span>`;
}

function showScannedPDFResult() {
  document.getElementById('result').innerHTML = `
    <h3>üì∏ Image-Based PDF Detected</h3>
    <p><strong>Status:</strong> Cannot extract text (scanned document)</p>
    <p><strong>Solution:</strong></p>
    <ul>
      <li>Convert to searchable PDF using Adobe Acrobat / Google Drive OCR</li>
      <li>Use papers from SciFinder/Scopus (usually text-selectable)</li>
      <li>Try "Print to PDF" from original source</li>
    </ul>
    <p><strong>Score:</strong> 10/80 (basic structure detected)</p>
  `;
}
</script>

</body>
</html>
